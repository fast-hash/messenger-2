# Crypto Design Overview

## 1. Ключевые материалы и хранилища (identity, prekeys, session state, per-file keys)
- **Identity keys:** долговременные пары ключей (Ed25519) для подписи и проверки сообщений, хранятся только на клиенте.
- **Signed/one-time prekeys:** предварительно загруженные в сервис наборы ключей X25519, используемые при инициализации X3DH; хранятся в защищённом локальном хранилище клиента и публикуются на сервере в зашифрованном виде.
- **Session state:** материал Double Ratchet (root chain, sending/receiving chains, счетчики сообщений) держится в памяти клиента и сохраняется в зашифрованный контейнер после каждого шага рачета.
- **Per-file keys:** уникальные 256-битные ключи AES-GCM, генерируемые на клиентах для каждого вложения; ключи и IV никогда не записываются в открытом виде и удаляются после отправки/приёма.

## 2. Потоки X3DH: инициация, повтор, потери пакетов
- **Инициация:** отправитель получает публичные ключи получателя (identity, signed prekey, one-time prekey) через bootstrap API, проверяет подпись и выполняет X25519-обмены для получения master secret.
- **Повтор соединения:** при повторном подключении отправитель использует свежий signed prekey и проверяет, не истёк ли one-time prekey; при отсутствии свободных prekey инициируется запрос на пополнение.
- **Потери пакетов:** инициатор пересылает сообщение инициации до подтверждения приёма; получатель хранит использованные one-time prekeys, чтобы отклонять повторное использование и защищаться от атак повтора.

## 3. Double Ratchet: отправка/приём, порядок/реплей, break-in recovery
- **Отправка/приём:** каждое сообщение вызывает односторонний шаг рачета на стороне отправки или приёма, создавая новые ключи симметричного шифрования и MAC.
- **Порядок/реплей:** сообщения маркируются монотонными счетчиками; пропущенные сообщения добавляются в очередь отложенных ключей для восстановления порядка и защиты от повторной передачи.
- **Break-in recovery:** при обнаружении компрометации выполняется принудительный DH-рачет с использованием свежих prekey, обнуляются старые цепочки и ключи, пользователю отображается предупреждение о необходимости переподтверждения.

## 4. Вложения: AES-GCM, одноразовый ключ/iv, тег аутентификации
- Для каждого файла генерируется случайный ключ AES-256 и уникальный IV; данные шифруются локально в режиме GCM, а тег аутентификации прикрепляется к сообщению метаданных.
- Ключи вложений передаются по зашифрованному каналу Double Ratchet, привязанному к конкретной сессии, и уничтожаются после подтверждённой доставки.

## 5. Что никогда не покидает клиент
- Приватные identity ключи и мастер-секреты Double Ratchet.
- Неиспользованные one-time prekeys до публикации и все использованные после списания.
- Локальные истории сообщений и вложения в расшифрованном виде.
- Метаданные сессии (root chain, chain keys, skipped message keys) в открытом виде.
- Пароли и материалы восстановления, позволяющие восстановить ключи.
