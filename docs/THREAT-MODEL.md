# Threat Model

## Активы

- Приватные identity-ключи и наборы pre-keys в IndexedDB клиента.【F:client/src/crypto/keystore.js†L1-L252】
- Сеансовые ключи и состояние Signal, хранимые в изолированном воркере и памяти клиента.【F:client/src/crypto/signal.js†L1-L226】
- Зашифрованные сообщения и метаданные в MongoDB.【F:server/src/models/Message.js†L1-L16】
- Токены JWT, используемые для аутентификации REST и Socket.IO.【F:server/src/routes/auth.js†L9-L44】【F:server/src/app.js†L78-L142】

## Границы доверия

1. **Браузер пользователя** — доверенная среда, где выполняется шифрование и хранится ключевой материал.
2. **Сервер приложения** — доверяет JWT, но не имеет доступа к открытым сообщениям.
3. **MongoDB/Redis** — хранят только base64-шифротексты и дайджесты повторов.

## STRIDE-анализ (кратко)

| Угроза                 | Вектор                       | Митигирующие меры                                                      | Остаточный риск                                                           |
| ---------------------- | ---------------------------- | ---------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| Spoofing               | Подделка клиента в Socket.IO | JWT-хендшейк с проверкой аудит/issuer и участника чата перед join      | Компрометированный JWT даёт доступ до истечения срока                     |
| Tampering              | Повреждение ciphertext       | AEAD libsignal проверяет MAC, расшифровка в клиенте выбрасывает ошибку | Пользователь видит ошибку, сообщение отбрасывается                        |
| Repudiation            | Отрицание отправки           | MongoDB хранит `senderId`, а события идут после записи                 | Защищено на уровне приложения, но нет криптографической подписи сообщений |
| Information Disclosure | Утечка plaintext             | Сервер принимает/отдаёт только encryptedPayload, логи не содержат тел  | Компрометированный клиент или XSS в воркере может раскрыть данные         |
| Denial of Service      | Flood `/api/messages`        | Rate-limit и TTL redis предотвращают дубликаты и перегрузку            | Сетевая атака может исчерпать лимиты пользователя                         |
| Elevation of Privilege | Чужой чат                    | Проверка членства `Chat.isMember` при REST и Socket.IO                 | Если база повреждена, проверка может дать ложный доступ                   |

## Decision Log

- **E2E вместо серверной дешифровки** — сервер остаётся «слепым», что упрощает соблюдение требований приватности и уменьшает поверхность атаки.【F:server/src/routes/messages.js†L17-L95】
- **Base64** — унифицированный текстовый формат для передачи бинарного ciphertext по REST/Socket.IO без утечки структур.【F:client/src/api/api.js†L9-L40】
- **Web Worker** — изоляция libsignal с `eval`, чтобы CSP оставалась строгой и основной поток не требовал `unsafe-eval`.【F:client/src/crypto/worker/crypto.browser.worker.js†L1-L18】【F:client/index.html†L6-L12】
- **Redis replay guard** — защита от повторного воспроизведения сообщений, необходимых для подтверждения приема.【F:server/src/services/replayGuard.js†L1-L67】
