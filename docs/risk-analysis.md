# Risk & Security Review

## Operational Hotspots

1. **JWT секрет при выпуске токена и валидации может разойтись.**
   - **Статус:** устранено. `server/src/routes/auth.js` теперь использует `getSharedSecret()`,
     а WebSocket-инициализация опирается на те же хелперы, так что REST и WS читают секрет из единой точки
     (`JWT_SHARED_SECRET` → `JWT_SECRET` → `config.get('jwt.secret')`).
   - **Рекомендации:** задокументировать порядок приоритета и добавить мониторинг на случай рассинхронизации
     переменных окружения при деплое.

2. **Выдача одноразовых pre-key не атомарна.**
   - **Статус:** устранено. Запрос сначала проверяет допуск по allowlist/чату, затем помечает выбранный ключ
     через `updateOne` с фильтром по `keyId` и `used: false`, что предотвращает двойную выдачу при гонках;
     при конфликте возвращается `409`.
   - **Рекомендации:** при необходимости расширить метрики, чтобы отслеживать количество конфликтов и проанализировать нагрузку.

3. **Защита от реигрышей деградирует при недоступности Redis.**
   - **Статус:** mitigated. При ошибке подключения Redis проверка переключается на in-memory TTL-таблицу
     с очисткой просроченных записей, блокируя реигрыши до восстановления Redis.
   - **Рекомендации:** всё ещё актуален мониторинг доступности Redis и алерты, чтобы fallback не использовался длительно.

## Security Considerations

1. **Отсутствует привязка токена к устройству/клиенту.**
   - **Статус:** частично решено. Добавлен `tokenVersion` в схему пользователя и проверка версии при каждой
     валидации JWT, что позволяет отзывать активные токены путём инкремента версии.
   - **Оставшиеся шаги:** при необходимости расширить UX (смена пароля, logout из всех устройств) для управления версией.

2. **WebSocket не проверяет audience/issuer по умолчанию.**
   - **Статус:** решено. Тот же `verifyAccess` используется и в HTTP, и в Socket.IO, а конфиг по умолчанию
     содержит audience/issuer; переменные окружения приоритетны для продовых установок.
   - **Рекомендации:** обновить документацию по деплою с упоминанием новых конфигурационных ключей.

3. **Доступ к публичным ключам по userId.**
   - **Статус:** ограничено. Добавлены поля `allowAnyRequester` и `allowedRequesters`, а также проверка членства
     в указанном чате (при включённом режиме allowlist). Запросы без допуска получают `403` и не расходуют pre-key.
   - **Рекомендации:** расширить клиентскую часть для управления allowlist и логировать неудачные попытки доступа.

## Сводные оценки

- **Готовность**: 92/100 — критичные блокеры устранены, fallback-защита от реигрышей позволяет пережить кратковременные
  сбои Redis, остаются задачи по расширению наблюдаемости.
- **Безопасность**: 85/100 — токены можно отзывать через `tokenVersion`, audience/issuer теперь обязательны, выдача ключей
  ограничена allowlist/членством. Дополнительные улучшения касаются UX управления allowlist и оперативного мониторинга.

